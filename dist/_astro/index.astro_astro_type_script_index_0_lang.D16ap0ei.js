class u{currentPanel;messages;isGenerating;preferences;constructor(){this.currentPanel="chat",this.messages=[],this.isGenerating=!1,this.preferences=this.loadPreferences(),this.init()}init(){this.setupEventListeners(),this.loadModels(),this.checkOnboarding(),this.applyTheme()}loadPreferences(){return{theme:localStorage.getItem("smile-theme")||"smile",selectedModel:localStorage.getItem("smile-model")||"gpt-oss:20b",onboarded:localStorage.getItem("smile-onboarded")==="true",ttsEnabled:localStorage.getItem("smile-tts-enabled")==="true"}}savePreferences(){localStorage.setItem("smile-theme",this.preferences.theme),localStorage.setItem("smile-model",this.preferences.selectedModel),localStorage.setItem("smile-onboarded",String(this.preferences.onboarded)),localStorage.setItem("smile-tts-enabled",String(this.preferences.ttsEnabled))}checkOnboarding(){if(!this.preferences.onboarded){const e=document.getElementById("onboarding-modal");e&&e.classList.add("modal-open")}}async loadModels(){try{const e=await fetch("http://localhost:11434/api/tags"),t=await e.json(),n=document.getElementById("model-select"),s=document.getElementById("onboarding-model-select");e.ok&&t.models.length>0?(n&&(n.innerHTML=""),s&&(s.innerHTML=""),t.models.forEach(r=>{const i=document.createElement("option");i.value=r.name,i.textContent=r.name;const m=i.cloneNode(!0);r.name===this.preferences.selectedModel&&(i.selected=!0,m.selected=!0),n&&n.appendChild(i),s&&s.appendChild(m)})):(n&&(n.innerHTML="<option>‚ö†Ô∏è Ollama not connected</option>"),s&&(s.innerHTML="<option>‚ö†Ô∏è Ollama not connected</option>"))}catch(e){console.error("Failed to load models:",e);const t=document.getElementById("model-select"),n=document.getElementById("onboarding-model-select");t&&(t.innerHTML="<option>‚ö†Ô∏è Connection failed</option>"),n&&(n.innerHTML="<option>‚ö†Ô∏è Connection failed</option>")}}setupEventListeners(){document.querySelectorAll("[data-panel]").forEach(o=>{o.addEventListener("click",a=>{const d=a.target.dataset.panel;d&&this.switchPanel(d)})});const e=document.getElementById("send-btn"),t=document.getElementById("message-input");e&&e.addEventListener("click",()=>this.sendMessage()),t&&t.addEventListener("keydown",o=>{o.key==="Enter"&&!o.shiftKey&&(o.preventDefault(),this.sendMessage())});const n=document.getElementById("theme-select");n&&n.addEventListener("change",o=>{const a=o.target;this.preferences.theme=a.value,this.applyTheme(),this.savePreferences()});const s=document.getElementById("tts-enabled");s&&s.addEventListener("change",o=>{const a=o.target;this.preferences.ttsEnabled=a.checked,this.savePreferences()});const r=document.getElementById("model-select");r&&r.addEventListener("change",o=>{const a=o.target;this.preferences.selectedModel=a.value,this.savePreferences()});const i=document.getElementById("breath-btn");i&&i.addEventListener("click",()=>{alert("ü´Å Breathing exercise coming soon! Take a deep breath for now.")});const m=document.getElementById("sounds-btn");m&&m.addEventListener("click",()=>{alert("üéµ Soundscapes coming soon! Enjoy the silence.")});const g=document.getElementById("theme-toggle-btn");g&&g.addEventListener("click",()=>{const o=["smile","light","dark"],a=o.indexOf(this.preferences.theme);this.preferences.theme=o[(a+1)%o.length],this.applyTheme(),this.savePreferences()});const l=document.getElementById("clear-data-btn");l&&l.addEventListener("click",()=>{confirm("Are you sure you want to clear all data? This cannot be undone.")&&(localStorage.clear(),location.reload())});const h=document.getElementById("onboarding-complete");h&&h.addEventListener("click",()=>{const o=document.getElementById("onboarding-model-select"),a=document.getElementById("onboarding-tts");o&&(this.preferences.selectedModel=o.value),a&&(this.preferences.ttsEnabled=a.checked),this.preferences.onboarded=!0,this.savePreferences();const c=document.getElementById("onboarding-modal");c&&c.classList.remove("modal-open")}),document.querySelectorAll(".theme-option").forEach(o=>{o.addEventListener("click",a=>{const c=a.target;document.querySelectorAll(".theme-option").forEach(p=>{p.classList.remove("btn-primary"),p.classList.add("btn-outline")}),c.classList.add("btn-primary"),c.classList.remove("btn-outline");const d=c.dataset.theme;d&&(this.preferences.theme=d,this.applyTheme())})})}switchPanel(e){document.querySelectorAll("[data-panel]").forEach(s=>{s.classList.remove("btn-primary"),s.classList.add("btn-ghost")});const t=document.querySelector(`[data-panel="${e}"]`);t&&(t.classList.add("btn-primary"),t.classList.remove("btn-ghost")),document.querySelectorAll('[id^="panel-"]').forEach(s=>{s.classList.add("hidden")});const n=document.getElementById(`panel-${e}`);n&&n.classList.remove("hidden"),this.currentPanel=e}applyTheme(){document.documentElement.setAttribute("data-theme",this.preferences.theme);const e=document.getElementById("theme-select");e&&(e.value=this.preferences.theme)}async sendMessage(){const e=document.getElementById("message-input");if(!e)return;const t=e.value.trim();if(!t||this.isGenerating)return;e.value="";const n=document.getElementById("empty-state");n&&(n.style.display="none"),this.addMessage("user",t),this.isGenerating=!0,this.updateSendButton();try{await this.generateResponse(t)}catch(s){console.error("Error generating response:",s),this.addMessage("assistant","‚ö†Ô∏è Sorry, I encountered an error. Please make sure Ollama is running and try again.")}this.isGenerating=!1,this.updateSendButton()}addMessage(e,t){const n=document.getElementById("messages-container");if(!n)return;const s=document.createElement("div");s.className=`message ${e}`;const r=document.createElement("div");r.className="message-content",r.textContent=t,s.appendChild(r),n.appendChild(s),n.scrollTop=n.scrollHeight,this.messages.push({role:e,content:t,timestamp:Date.now()})}async generateResponse(e){const t=document.getElementById("messages-container");if(!t)return;const n=document.createElement("div");n.className="message assistant";const s=document.createElement("div");s.className="message-content",s.textContent="",n.appendChild(s),t.appendChild(n);try{const r=await fetch("http://localhost:11434/api/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:this.preferences.selectedModel,messages:[...this.messages.map(h=>({role:h.role,content:h.content})),{role:"user",content:e}],stream:!0})});if(!r.ok)throw new Error(`HTTP ${r.status}`);const i=r.body?.getReader();if(!i)throw new Error("No response stream");const m=new TextDecoder;let g="",l="";for(;;){const{done:h,value:o}=await i.read();if(h)break;g+=m.decode(o,{stream:!0});const a=g.split(`
`);g=a.pop()||"";for(const c of a)if(c.trim())try{const d=JSON.parse(c);if(d.message?.content&&(l+=d.message.content,s.textContent=l,t.scrollTop=t.scrollHeight),d.done){this.messages.push({role:"assistant",content:l,timestamp:Date.now()}),this.preferences.ttsEnabled&&l.trim()&&this.speakText(l);return}}catch{console.warn("Failed to parse response line:",c)}}}catch(r){throw s.textContent="‚ö†Ô∏è Failed to get response. Please check your Ollama connection.",r}}speakText(e){if(typeof window<"u"&&"speechSynthesis"in window){const t=new window.SpeechSynthesisUtterance(e);t.rate=.9,t.pitch=1,t.volume=.8,window.speechSynthesis.speak(t)}}updateSendButton(){const e=document.getElementById("send-btn");e&&(this.isGenerating?(e.textContent="...",e.disabled=!0):(e.textContent="Send",e.disabled=!1))}}document.addEventListener("DOMContentLoaded",()=>{window.smileApp=new u});
