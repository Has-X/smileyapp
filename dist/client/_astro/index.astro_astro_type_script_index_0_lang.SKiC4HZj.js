class g{models=[];selectedModel="";isOnboardingComplete=!1;constructor(){this.init()}async init(){this.initTheme(),await this.loadPreferences(),this.isOnboardingComplete=localStorage.getItem("smile-onboarding")==="complete",this.setupEventListeners(),this.initAmbientBackground(),await this.loadModels(),this.isOnboardingComplete||this.showOnboarding(),this.switchPanel("chat")}initTheme(){const e=localStorage.getItem("smile-theme-mode")||"auto",t=localStorage.getItem("smile-accent-color")||"smile";this.setTheme(this.resolveThemeName(e,t)),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",o=>{if(localStorage.getItem("smile-theme-mode")==="auto"){const s=localStorage.getItem("smile-accent-color")||"smile",r=o.matches?"dark":"light";this.setTheme(this.resolveThemeName(r,s))}})}resolveThemeName(e,t){const o=["dark","light","auto"].includes(e)?e:"auto",n=t||"smile";return o==="dark"?`${n}-dark`:o==="auto"&&window.matchMedia("(prefers-color-scheme: dark)").matches?`${n}-dark`:n}setTheme(e){document.documentElement.setAttribute("data-theme",e),localStorage.setItem("smile-theme",e);const t=document.getElementById("theme-select");t&&(t.value=e)}async loadPreferences(){const e=localStorage.getItem("smile-selected-model");e&&(this.selectedModel=e);const t=localStorage.getItem("smile-tts-enabled")==="true",o=document.getElementById("tts-enabled");o&&(o.checked=t)}setupEventListeners(){document.querySelectorAll(".nav-button[data-panel]").forEach(n=>{n.addEventListener("click",s=>{const i=s.currentTarget.getAttribute("data-panel");i&&this.switchPanel(i)})}),this.initViewToggles();const t=document.getElementById("message-input"),o=document.getElementById("send-btn");t&&o&&(t.addEventListener("input",()=>{this.autoResizeTextarea(t)}),t.addEventListener("keydown",n=>{n.key==="Enter"&&!n.shiftKey&&(n.preventDefault(),this.sendMessage())}),o.addEventListener("click",()=>{this.sendMessage()})),this.setupSettingsListeners(),this.setupOnboardingListeners(),this.initHistorySearch()}setupSettingsListeners(){document.querySelectorAll(".tab-button").forEach(l=>{l.addEventListener("click",()=>{const c=l.getAttribute("data-tab");this.switchSettingsTab(c)})}),document.querySelectorAll(".color-theme-card").forEach(l=>{l.addEventListener("click",()=>{const c=l.getAttribute("data-theme");c&&this.setAccentColor(c)})});const o=document.getElementById("theme-mode-select");if(o){const l=localStorage.getItem("smile-theme-mode")||"auto";o.value=l,o.addEventListener("change",c=>{const m=c.target;this.setThemeMode(m.value)})}const n=document.getElementById("model-select");n&&n.addEventListener("change",l=>{const c=l.target;this.selectedModel=c.value,localStorage.setItem("smile-selected-model",this.selectedModel)});const s=document.getElementById("response-style");if(s){const l=localStorage.getItem("smile-response-style")||"supportive";s.value=l,s.addEventListener("change",c=>{const m=c.target;localStorage.setItem("smile-response-style",m.value)})}const r=document.getElementById("theme-select");r&&r.addEventListener("change",l=>{const c=l.target;this.setTheme(c.value)});const i=document.getElementById("tts-enabled");i&&i.addEventListener("change",l=>{const c=l.target;localStorage.setItem("smile-tts-enabled",c.checked.toString())});const a=document.getElementById("clear-data-btn");a&&a.addEventListener("click",()=>{this.showClearDataModal()})}setupOnboardingListeners(){const e=document.querySelectorAll(".theme-card");e.forEach(o=>{o.addEventListener("click",n=>{const s=n.currentTarget,r=s.getAttribute("data-theme");r&&(e.forEach(i=>i.classList.remove("theme-card-active")),s.classList.add("theme-card-active"),this.setTheme(r))})});const t=document.getElementById("onboarding-complete");t&&t.addEventListener("click",()=>{this.completeOnboarding()})}showOnboarding(){const e=document.getElementById("onboarding-modal");if(e){e.style.display="flex",requestAnimationFrame(()=>{e.classList.add("modal-active")});const t=document.getElementById("onboarding-model-select");t&&this.models.length>0?(t.innerHTML=this.models.map(o=>`<option value="${o}">${o}</option>`).join(""),this.selectedModel?t.value=this.selectedModel:this.models.length>0&&(t.value=this.models[0],this.selectedModel=this.models[0])):t.innerHTML="<option>No models available - Install Ollama first</option>"}}completeOnboarding(){const e=document.getElementById("onboarding-model-select");e&&(this.selectedModel=e.value,localStorage.setItem("smile-selected-model",this.selectedModel));const t=document.getElementById("onboarding-tts");t&&localStorage.setItem("smile-tts-enabled",t.checked.toString()),localStorage.setItem("smile-onboarding","complete"),this.isOnboardingComplete=!0;const o=document.getElementById("onboarding-modal");o&&(o.classList.remove("modal-active"),setTimeout(()=>{o.style.display="none"},300)),this.updateModelSelects(),this.showCustomNotification("Welcome to Smile AI! 🎉","success")}showClearDataModal(){confirm("Are you sure you want to clear all data? This will remove all chat history and preferences.")&&(Object.keys(localStorage).filter(t=>t.startsWith("smile-")).forEach(t=>localStorage.removeItem(t)),this.clearMessages(),this.isOnboardingComplete=!1,this.showOnboarding())}initViewToggles(){try{document.querySelectorAll(".view-toggle").forEach(t=>{const o=t.getAttribute("data-panel-id");o&&this.initializeViewToggle(t,o)})}catch(e){console.warn("Error initializing view toggles:",e)}}initializeViewToggle(e,t){try{const o=e.querySelectorAll(".view-toggle-btn"),n=document.getElementById(t);if(!n){console.warn(`Panel not found: ${t}`);return}const s=localStorage.getItem(`view-${t}`)||"tiles";this.setView(n,s,o),o.forEach(i=>{const a=i.cloneNode(!0);i.parentNode?.replaceChild(a,i)});const r=e.querySelectorAll(".view-toggle-btn");r.forEach(i=>{i.addEventListener("click",()=>{const a=i.getAttribute("data-view");a&&(this.setView(n,a,r),localStorage.setItem(`view-${t}`,a))})})}catch(o){console.warn(`Error initializing view toggle for panel ${t}:`,o)}}setView(e,t,o){try{console.log("=== VIEW TOGGLE DEBUG ==="),console.log("Setting view:",t,"on panel:",e.id);const n=[".memory-grid",".journal-entries-container",".exercise-grid",".history-container",".content-grid",".entries-container"];let s=null;for(const i of n){const a=e.querySelector(i);if(a){s=a,console.log("Found target container:",i);break}}s||(s=e.querySelector("[data-view-container]"),s&&console.log("Found fallback container with data-view-container")),this.animateViewTransition(s,()=>{s&&this.applyViewLayout(s,t)}),o.forEach(i=>{const a=i.getAttribute("data-view");i.classList.toggle("active",a===t)});const r=e.getAttribute("id");r&&localStorage.setItem(`view-${r}`,t),console.log("=== VIEW TOGGLE COMPLETE ===")}catch(n){console.error("Error setting view:",n),n instanceof Error&&console.error("Stack trace:",n.stack)}}applyViewLayout(e,t){t==="tiles"?(e.style.display="flex",e.style.flexDirection="column",e.style.gap="1.25rem",e.style.gridTemplateColumns=""):(e.style.display="grid",e.style.gridTemplateColumns="repeat(auto-fill, minmax(280px, 1fr))",e.style.gap="1rem",e.style.flexDirection=""),console.log("Applied",t,"layout to container:",e.className)}animateViewTransition(e,t){if(!e){t();return}e.style.transition="all 0.3s cubic-bezier(0.4, 0, 0.2, 1)",e.style.opacity="0.6",e.style.transform="translateY(8px) scale(0.98)",setTimeout(()=>{t(),requestAnimationFrame(()=>{e.style.opacity="1",e.style.transform="translateY(0) scale(1)",setTimeout(()=>{e.style.transition="",e.style.transform=""},300)})},50)}switchPanel(e){console.log("[switchPanel] switching to",e);const t=document.querySelectorAll('[id^="panel-"]');t.forEach(r=>{r.classList.add("hidden")});const o=document.getElementById(`panel-${e}`);if(o?(o.classList.remove("hidden"),console.log("[switchPanel] showed",o.id)):console.warn("[switchPanel] target panel not found",e),!Array.from(t).some(r=>!r.classList.contains("hidden"))){const r=document.getElementById("panel-chat");r&&(r.classList.remove("hidden"),console.warn("[switchPanel] all panels hidden; forcing chat visible"))}document.querySelectorAll(".nav-button[data-panel]").forEach(r=>{r.classList.remove("nav-button-active"),r.getAttribute("data-panel")===e&&r.classList.add("nav-button-active")}),e==="memories"&&this.initMemoriesPanel(),e==="history"&&this.initHistoryPanel(),e==="journal"&&this.initJournalPanel(),e==="profile"&&this.initProfilePanel(),this.initViewToggles()}switchSettingsTab(e){document.querySelectorAll(".tab-content").forEach(r=>{r.classList.remove("active")});const o=document.querySelector(`[data-tab-content="${e}"]`);o&&o.classList.add("active"),document.querySelectorAll(".tab-button").forEach(r=>{r.classList.remove("active")});const s=document.querySelector(`[data-tab="${e}"]`);s&&s.classList.add("active")}setThemeMode(e){localStorage.setItem("smile-theme-mode",e);const t=localStorage.getItem("smile-accent-color")||"smile";this.setTheme(this.resolveThemeName(e,t))}setAccentColor(e){localStorage.setItem("smile-accent-color",e),document.querySelectorAll(".color-theme-card").forEach(s=>{s.classList.remove("active")});const o=document.querySelector(`[data-theme="${e}"]`);o&&o.classList.add("active");const n=localStorage.getItem("smile-theme-mode")||"auto";this.setTheme(this.resolveThemeName(n,e))}autoResizeTextarea(e){e.style.height="auto",e.style.height=Math.min(e.scrollHeight,128)+"px"}async loadModels(){try{const e=await fetch("/api/ollama-health");if(e.ok){const t=await e.json();t.available&&t.models?(this.models=t.models,this.updateModelSelects()):(this.models=[],this.updateModelSelects())}}catch(e){console.log("Ollama not available:",e),this.models=[],this.updateModelSelects()}}updateModelSelects(){document.querySelectorAll("#model-select, #onboarding-model-select").forEach(t=>{this.models.length>0?(t.innerHTML=this.models.map(o=>`<option value="${o}">${o}</option>`).join(""),this.selectedModel&&this.models.includes(this.selectedModel)?t.value=this.selectedModel:this.models.length>0&&(t.value=this.models[0],this.selectedModel=this.models[0],localStorage.setItem("smile-selected-model",this.selectedModel))):t.innerHTML="<option>No models available</option>"})}async sendMessage(){const e=document.getElementById("message-input");if(!e)return;const t=e.value.trim();if(!t)return;if(!this.selectedModel){this.showCustomNotification("Please select a model first","error");return}e.value="",e.style.height="auto";const o=document.getElementById("empty-state");o&&(o.style.display="none"),this.addMessage("user",t);const n=this.addMessage("assistant","");try{const s=await fetch("/api/ollama",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:t,model:this.selectedModel})});if(!s.ok)throw new Error(`HTTP error! status: ${s.status}`);const r=s.body?.getReader(),i=new TextDecoder;let a="";if(r)for(;;){const{done:l,value:c}=await r.read();if(l)break;const u=i.decode(c).split(`
`);for(const d of u)if(d.startsWith("data: "))try{const h=JSON.parse(d.slice(6));h.content&&(a+=h.content,this.updateMessage(n,a))}catch{}}}catch(s){console.error("Error sending message:",s),this.updateMessage(n,"Sorry, I encountered an error. Please make sure Ollama is running and try again."),this.showCustomNotification("Connection error. Check if Ollama is running.","error")}}addMessage(e,t){const o=document.getElementById("messages-container");if(!o)return"";const n=`message-${Date.now()}-${Math.random().toString(36).substring(2,9)}`,s=document.createElement("div");s.id=n,s.className=`message ${e==="user"?"message-user":""}`;const r=document.createElement("div");r.className="message-avatar",r.style.backgroundColor=e==="user"?"rgb(var(--md-primary))":"rgb(var(--md-surface-variant))",r.style.color=e==="user"?"rgb(var(--md-on-primary))":"rgb(var(--md-on-surface-variant))",r.textContent=e==="user"?"U":"A";const i=document.createElement("div");i.className="message-content";const a=document.createElement("div");a.className=`message-bubble ${e==="user"?"message-bubble-user":"message-bubble-assistant"}`,a.textContent=t;const l=document.createElement("div");return l.className="message-time",l.textContent=new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),i.appendChild(a),i.appendChild(l),s.appendChild(r),s.appendChild(i),o.appendChild(s),o.scrollTop=o.scrollHeight,n}updateMessage(e,t){const o=document.getElementById(e);if(o){const n=o.querySelector(".message-bubble");if(n){n.textContent=t;const s=document.getElementById("messages-container");s&&(s.scrollTop=s.scrollHeight)}}}clearMessages(){const e=document.getElementById("messages-container");if(e){e.querySelectorAll(".message").forEach(n=>n.remove());const o=document.getElementById("empty-state");o&&(o.style.display="flex")}}showCustomNotification(e,t="info"){const o=document.createElement("div");o.className="custom-notification",o.style.cssText=`
      position: fixed;
      bottom: 2rem;
      left: 50%;
      transform: translateX(-50%);
      background-color: ${t==="error"?"rgb(var(--md-error))":"rgb(var(--md-surface-variant))"};
      color: ${t==="error"?"rgb(var(--md-on-error))":"rgb(var(--md-on-surface-variant))"};
      padding: 1rem 1.5rem;
      border-radius: 0.5rem;
      box-shadow: var(--md-elevation-3);
      z-index: 1000;
      max-width: 90vw;
      text-align: center;
      font-weight: 500;
      animation: slideUpFadeIn 0.3s ease-out;
    `,o.textContent=e;const n=document.createElement("style");n.textContent=`
      @keyframes slideUpFadeIn {
        from {
          opacity: 0;
          transform: translateX(-50%) translateY(100%);
        }
        to {
          opacity: 1;
          transform: translateX(-50%) translateY(0);
        }
      }
    `,document.head.appendChild(n),document.body.appendChild(o),setTimeout(()=>{o.style.animation="slideUpFadeIn 0.3s ease-out reverse",setTimeout(()=>{o.parentNode&&o.parentNode.removeChild(o),n.parentNode&&n.parentNode.removeChild(n)},300)},4e3)}initAmbientBackground(){let e=0,t=0,o=!1;const n=()=>{const d=e/window.innerWidth*100,h=t/window.innerHeight*100;document.documentElement.style.setProperty("--mouse-x",`${d}%`),document.documentElement.style.setProperty("--mouse-y",`${h}%`),document.documentElement.style.setProperty("--interaction-intensity",o?"1":"0")},s=d=>{e+=(d.clientX-e)*.1,t+=(d.clientY-t)*.1,n()},r=()=>{o=!0,n()},i=()=>{o=!1,n()},a=d=>{d.touches.length>0&&(e=d.touches[0].clientX,t=d.touches[0].clientY,o=!0,n())},l=d=>{d.touches.length>0&&(e+=(d.touches[0].clientX-e)*.15,t+=(d.touches[0].clientY-t)*.15,n())},c=()=>{o=!1,n()};document.addEventListener("mousemove",s),document.addEventListener("mousedown",r),document.addEventListener("mouseup",i),document.addEventListener("touchstart",a,{passive:!0}),document.addEventListener("touchmove",l,{passive:!0}),document.addEventListener("touchend",c);const m=()=>{document.body.style.setProperty("--ambient-focus","1")},u=()=>{document.body.style.setProperty("--ambient-focus","0.7")};window.addEventListener("focus",m),window.addEventListener("blur",u),n(),m(),window.resetOnboarding=()=>{localStorage.removeItem("smile-onboarding"),location.reload()}}initMemoriesPanel(){this.setupMemoryFilters(),this.setupMemorySearch(),this.setupMemoryActions(),this.loadMemoriesData()}setupMemoryFilters(){const e=document.querySelectorAll(".memory-filter-btn");e.forEach(t=>{t.addEventListener("click",()=>{e.forEach(n=>n.classList.remove("memory-filter-active")),t.classList.add("memory-filter-active");const o=t.getAttribute("data-filter");this.filterMemories(o||"all")})})}setupMemorySearch(){const e=document.getElementById("memory-search");if(!e)return;let t;e.addEventListener("input",o=>{clearTimeout(t);const n=o.target.value.toLowerCase().trim();t=setTimeout(()=>{this.searchMemories(n)},300)})}setupMemoryActions(){const e=document.getElementById("add-memory-btn");e&&e.addEventListener("click",()=>{this.addMemoryEntry()});const t=document.getElementById("export-memories");t&&t.addEventListener("click",()=>{this.exportMemories()});const o=document.getElementById("generate-insights");o&&o.addEventListener("click",()=>{this.generateInsights()}),this.setupMemoryCardClickHandlers()}addMemoryEntry(){const e=document.getElementById("entry-type"),t=document.getElementById("entry-content");if(!e?.value){this.showCustomNotification("Please select a memory type","error");return}if(!t?.value.trim()){this.showCustomNotification("Please enter some content for your memory","error");return}const o={id:Date.now().toString(),type:e.value,content:t.value.trim(),date:new Date().toISOString(),timestamp:Date.now()};let n=JSON.parse(localStorage.getItem("memories")||"[]");n.unshift(o),localStorage.setItem("memories",JSON.stringify(n)),e.value="",t.value="",this.showCustomNotification("Memory saved successfully!","success"),this.loadMemoriesData()}setupMemoryCardClickHandlers(){document.querySelectorAll(".memory-card").forEach(t=>{t.addEventListener("click",o=>{const n=o.currentTarget;this.handleMemoryCardClick(n)})})}handleMemoryCardClick(e){if(e.dataset.conversationId)this.switchPanel("chat"),this.showCustomNotification("Loading conversation...","info");else if(e.classList.contains("insight-memory")){const o=e.querySelector(".memory-title")?.textContent||"Insight";this.showCustomNotification(`Viewing insight: ${o}`,"info")}else if(e.classList.contains("moment-memory")){const o=e.querySelector(".moment-title")?.textContent||"Moment";this.showCustomNotification(`Viewing moment: ${o}`,"info")}}exportMemories(){const e={conversations:this.getConversationMemories(),insights:this.getInsightMemories(),moments:this.getMomentMemories(),exportDate:new Date().toISOString(),version:"1.0"},t=JSON.stringify(e,null,2),o=new Blob([t],{type:"application/json"}),n=URL.createObjectURL(o),s=document.createElement("a");s.href=n,s.download=`smile-memories-${new Date().toISOString().split("T")[0]}.json`,s.click(),URL.revokeObjectURL(n),this.showCustomNotification("Memories exported successfully! 📁","success")}getConversationMemories(){return[]}getInsightMemories(){return[]}getMomentMemories(){return[]}searchMemories(e){const t=document.querySelectorAll(".memory-card"),o=document.querySelectorAll(".memory-section");if(!e){t.forEach(s=>{s.style.display="block"}),o.forEach(s=>{s.style.display="block"});return}let n=!1;t.forEach(s=>{const r=s,i=r.querySelector(".memory-title")?.textContent?.toLowerCase()||"",a=r.querySelector(".memory-excerpt, .moment-description")?.textContent?.toLowerCase()||"",l=Array.from(r.querySelectorAll(".memory-tag")).map(u=>u.textContent?.toLowerCase()||"").join(" "),m=`${i} ${a} ${l}`.includes(e);r.style.display=m?"block":"none",m&&(n=!0)}),o.forEach(s=>{const r=s,i=r.querySelectorAll('.memory-card[style*="block"]');r.style.display=i.length>0?"block":"none"}),!n&&e&&this.showCustomNotification(`No memories found for "${e}"`,"info")}filterMemories(e){const t=document.querySelectorAll(".memory-card"),o=document.querySelectorAll(".memory-section");t.forEach(n=>{const s=n;let r=!1;switch(e){case"all":r=!0;break;case"chats":r=s.classList.contains("conversation-memory");break;case"insights":r=s.classList.contains("insight-memory");break;case"moments":r=s.classList.contains("moment-memory");break}s.style.display=r?"block":"none",r&&(s.style.animation="fadeIn 0.3s ease")}),o.forEach(n=>{const s=n,r=s.querySelectorAll('.memory-card[style*="block"], .memory-card:not([style*="display: none"])');s.style.display=r.length>0?"block":"none"})}loadMemoriesData(){const e={all:42,chats:28,insights:8,moments:6};Object.entries(e).forEach(([o,n])=>{const s=document.querySelector(`[data-filter="${o}"] .filter-count`);s&&(s.textContent=n.toString())});const t=document.getElementById("memories-count");t&&(t.textContent=e.all.toString()),console.log("Memories data loaded with counts:",e)}generateInsights(){this.showCustomNotification("Generating new AI insights...","info"),setTimeout(()=>{const e=["You show increased emotional resilience during evening conversations","Your problem-solving approach has become more structured over time","Morning sessions tend to focus on goal-setting and motivation","You demonstrate strong self-awareness in your communication patterns","Your mindfulness practice has improved your stress response"],t=e[Math.floor(Math.random()*e.length)];this.showCustomNotification(`💡 New insight: ${t}`,"success")},2e3)}initHistoryPanel(){this.setupHistorySearch(),this.setupHistoryFilters(),this.setupHistoryActions(),this.loadConversationHistory()}setupHistorySearch(){const e=document.getElementById("history-search");if(!e)return;let t;e.addEventListener("input",o=>{clearTimeout(t);const n=o.target.value.toLowerCase().trim();t=setTimeout(()=>{this.searchHistory(n)},300)})}setupHistoryFilters(){const e=document.getElementById("history-filter");e&&e.addEventListener("change",()=>{this.filterHistory(e.value)})}setupHistoryActions(){const e=document.getElementById("clear-history");e&&e.addEventListener("click",()=>{this.clearHistory()});const t=document.getElementById("export-history");t&&t.addEventListener("click",()=>{this.exportHistory()});const o=document.getElementById("history-sort");o&&o.addEventListener("change",()=>{this.sortHistory(o.value)}),this.setupConversationClickHandlers()}setupConversationClickHandlers(){document.querySelectorAll(".conversation-item").forEach(t=>{const o=t.querySelector('[title="Resume conversation"]');o&&o.addEventListener("click",r=>{r.stopPropagation();const i=t.dataset.conversationId;this.resumeConversation(i)});const n=t.querySelector('[title="View conversation"]');n&&n.addEventListener("click",r=>{r.stopPropagation();const i=t.dataset.conversationId;this.viewConversation(i)});const s=t.querySelector('[title="Delete conversation"]');s&&s.addEventListener("click",r=>{r.stopPropagation();const i=t.dataset.conversationId;this.deleteConversation(i)})})}searchHistory(e){const t=document.querySelectorAll(".conversation-item");let o=0;t.forEach(s=>{const r=s,i=r.querySelector("p")?.textContent?.toLowerCase()||"",a=r.dataset.keywords?.toLowerCase()||"",l=`${i} ${a}`;!e||l.includes(e.toLowerCase())?(r.style.display="block",o++):r.style.display="none"});const n=document.getElementById("history-empty");n&&(n.style.display=o===0?"block":"none")}sortHistory(e){const t=document.getElementById("history-container");if(!t)return;const o=Array.from(t.querySelectorAll(".conversation-item"));o.sort((n,s)=>{const r=new Date(n.dataset.date||""),i=new Date(s.dataset.date||"");switch(e){case"oldest":return r.getTime()-i.getTime();case"longest":const a=parseInt(n.querySelector(".px-2")?.textContent?.match(/\d+/)?.[0]||"0");return parseInt(s.querySelector(".px-2")?.textContent?.match(/\d+/)?.[0]||"0")-a;case"shortest":const c=parseInt(n.querySelector(".px-2")?.textContent?.match(/\d+/)?.[0]||"0"),m=parseInt(s.querySelector(".px-2")?.textContent?.match(/\d+/)?.[0]||"0");return c-m;case"newest":default:return i.getTime()-r.getTime()}}),o.forEach(n=>{t.appendChild(n)})}exportHistory(){const t={conversations:Array.from(document.querySelectorAll(".conversation-item")).map(i=>{const a=i;return{date:a.dataset.date,keywords:a.dataset.keywords,preview:a.querySelector("p")?.textContent,messageCount:a.querySelector(".px-2")?.textContent,duration:a.querySelectorAll(".px-2")[1]?.textContent}}),exportDate:new Date().toISOString(),version:"1.0"},o=JSON.stringify(t,null,2),n=new Blob([o],{type:"application/json"}),s=URL.createObjectURL(n),r=document.createElement("a");r.href=s,r.download=`smile-conversation-history-${new Date().toISOString().split("T")[0]}.json`,r.click(),URL.revokeObjectURL(s),this.showCustomNotification("Conversation history exported successfully!","success")}viewConversation(e){if(!e){this.showCustomNotification("Unable to view conversation","error");return}this.showCustomNotification("Conversation details view coming soon","info")}filterHistory(e){const t=document.querySelectorAll(".conversation-item"),o=new Date;t.forEach(n=>{const s=n,r=s.dataset.date;if(!r){s.style.display="none";return}const i=new Date(r);let a=!1;switch(e){case"all":a=!0;break;case"today":a=this.isSameDay(i,o);break;case"week":const l=new Date(o.getTime()-10080*60*1e3);a=i>=l;break;case"month":const c=new Date(o.getTime()-720*60*60*1e3);a=i>=c;break}s.style.display=a?"block":"none"})}isSameDay(e,t){return e.getDate()===t.getDate()&&e.getMonth()===t.getMonth()&&e.getFullYear()===t.getFullYear()}loadConversationHistory(){const e=document.getElementById("history-count");e&&(e.textContent="0"),console.log("Conversation history loaded")}resumeConversation(e){if(!e){this.showCustomNotification("Unable to resume conversation","error");return}this.switchPanel("chat"),this.showCustomNotification("Resuming conversation...","info")}deleteConversation(e){if(!e){this.showCustomNotification("Unable to delete conversation","error");return}confirm("Are you sure you want to delete this conversation? This action cannot be undone.")&&this.showCustomNotification("Conversation deleted","success")}clearHistory(){if(confirm("Are you sure you want to clear all conversation history? This action cannot be undone.")){const e=document.getElementById("history-count");e&&(e.textContent="0"),this.showCustomNotification("All conversation history cleared","success")}}initJournalPanel(){this.setupJournalActions(),this.setupJournalSearch(),this.loadJournalEntries()}setupJournalActions(){const e=document.getElementById("new-entry-btn");e&&e.addEventListener("click",()=>{this.showNewEntryForm()});const t=document.getElementById("cancel-entry-btn");t&&t.addEventListener("click",()=>{this.hideNewEntryForm()});const o=document.getElementById("save-entry-btn");o&&o.addEventListener("click",()=>{this.saveJournalEntry()});const n=document.getElementById("save-draft-btn");n&&n.addEventListener("click",()=>{this.saveJournalDraft()}),this.setupEntryActionButtons()}setupJournalSearch(){const e=document.getElementById("journal-search"),t=document.getElementById("journal-filter");if(e){let o;e.addEventListener("input",n=>{clearTimeout(o);const s=n.target.value.toLowerCase().trim();o=setTimeout(()=>{this.searchJournalEntries(s)},300)})}t&&t.addEventListener("change",o=>{const n=o.target.value;this.filterJournalEntries(n)})}setupEntryActionButtons(){document.querySelectorAll(".journal-entry-card").forEach(t=>{const o=t.querySelector('.journal-entry-action[title="Edit"]'),n=t.querySelector('.journal-entry-action[title="Delete"]');o&&o.addEventListener("click",s=>{s.stopPropagation(),this.editJournalEntry(t)}),n&&n.addEventListener("click",s=>{s.stopPropagation(),this.deleteJournalEntry(t)})})}showNewEntryForm(){const e=document.getElementById("new-entry-form");if(e){e.classList.remove("hidden");const t=document.getElementById("entry-title");t&&t.focus()}}hideNewEntryForm(){const e=document.getElementById("new-entry-form");e&&(e.classList.add("hidden"),this.clearEntryForm())}clearEntryForm(){const e=document.getElementById("entry-title"),t=document.getElementById("entry-content"),o=document.getElementById("entry-mood");e&&(e.value=""),t&&(t.value=""),o&&(o.value="")}saveJournalEntry(){const e=document.getElementById("entry-title"),t=document.getElementById("entry-content"),o=document.getElementById("entry-mood");if(!t?.value.trim()){this.showCustomNotification("Please write something in your journal entry","error");return}const n={id:`entry-${Date.now()}`,title:e?.value.trim()||"Untitled Entry",content:t.value.trim(),mood:o?.value||"",date:new Date,isDraft:!1};this.addJournalEntryToDOM(n),this.hideNewEntryForm(),this.showCustomNotification("Journal entry saved! 📝","success"),this.updateJournalEntryCount()}saveJournalDraft(){const e=document.getElementById("entry-content");if(!e?.value.trim()){this.showCustomNotification("Please write something to save as draft","error");return}localStorage.setItem("journalDraft",e.value),this.showCustomNotification("Draft saved! 💾","info")}addJournalEntryToDOM(e){const t=document.getElementById("journal-entries");if(!t)return;const o=this.createJournalEntryElement(e);t.insertBefore(o,t.firstChild)}createJournalEntryElement(e){const t=document.createElement("div");t.className="journal-entry-card",t.dataset.date=e.date.toISOString().split("T")[0];const o=this.getMoodEmoji(e.mood),n=this.formatJournalDate(e.date);return t.innerHTML=`
      <div class="journal-entry-header">
        <div class="journal-entry-date">
          <div class="journal-date-day">${e.date.getDate()}</div>
          <div class="journal-date-month">${e.date.toLocaleDateString("en",{month:"short"})}</div>
        </div>
        <div class="journal-entry-meta">
          <h3 class="journal-entry-title">${e.title}</h3>
          <div class="journal-entry-info">
            <span class="journal-entry-time">${n}</span>
            ${e.mood?`<span class="journal-entry-mood">${o}</span>`:""}
          </div>
        </div>
        <div class="journal-entry-actions">
          <button class="journal-entry-action" title="Edit">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
            </svg>
          </button>
          <button class="journal-entry-action" title="Delete">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
            </svg>
          </button>
        </div>
      </div>
      <div class="journal-entry-content">
        <p>${e.content}</p>
      </div>
    `,this.setupSingleEntryActions(t),t}setupSingleEntryActions(e){const t=e.querySelector('.journal-entry-action[title="Edit"]'),o=e.querySelector('.journal-entry-action[title="Delete"]');t&&t.addEventListener("click",n=>{n.stopPropagation(),this.editJournalEntry(e)}),o&&o.addEventListener("click",n=>{n.stopPropagation(),this.deleteJournalEntry(e)})}getMoodEmoji(e){return{great:"😊",good:"🙂",okay:"😐",down:"😔",anxious:"😰"}[e]||"😐"}formatJournalDate(e){const o=new Date().getTime()-e.getTime(),n=Math.floor(o/(1e3*60*60*24));return n===0?`Today, ${e.toLocaleTimeString("en",{hour:"numeric",minute:"2-digit"})}`:n===1?`Yesterday, ${e.toLocaleTimeString("en",{hour:"numeric",minute:"2-digit"})}`:`${n} days ago, ${e.toLocaleTimeString("en",{hour:"numeric",minute:"2-digit"})}`}editJournalEntry(e){const t=e.querySelector(".journal-entry-title")?.textContent||"",o=e.querySelector(".journal-entry-content p")?.textContent||"";this.showCustomNotification(`Editing: ${t}`,"info"),this.showNewEntryForm();const n=document.getElementById("entry-title"),s=document.getElementById("entry-content");n&&(n.value=t),s&&(s.value=o)}deleteJournalEntry(e){const t=e.querySelector(".journal-entry-title")?.textContent||"this entry";confirm(`Are you sure you want to delete "${t}"?`)&&(e.remove(),this.showCustomNotification("Journal entry deleted","info"),this.updateJournalEntryCount())}searchJournalEntries(e){document.querySelectorAll(".journal-entry-card").forEach(o=>{const n=o,s=n.querySelector(".journal-entry-title")?.textContent?.toLowerCase()||"",r=n.querySelector(".journal-entry-content")?.textContent?.toLowerCase()||"",i=!e||s.includes(e)||r.includes(e);n.style.display=i?"block":"none"})}filterJournalEntries(e){const t=document.querySelectorAll(".journal-entry-card"),o=new Date;t.forEach(n=>{const s=n,r=new Date(s.dataset.date||"");let i=!0;switch(e){case"today":i=r.toDateString()===o.toDateString();break;case"week":const a=new Date(o.getTime()-10080*60*1e3);i=r>=a;break;case"month":const l=new Date(o.getTime()-720*60*60*1e3);i=r>=l;break;case"all":default:i=!0;break}s.style.display=i?"block":"none"})}loadJournalEntries(){this.updateJournalEntryCount()}updateJournalEntryCount(){const e=document.querySelectorAll('.journal-entry-card:not([style*="display: none"])'),t=document.getElementById("journal-entries-count");t&&(t.textContent=e.length.toString())}initProfilePanel(){this.loadProfileData(),this.setupProfileActions()}loadProfileData(){const e=JSON.parse(localStorage.getItem("smile-profile-data")||"{}");["profile-name","profile-pronouns","profile-age-range","profile-challenges","profile-triggers","profile-coping","profile-goals","profile-communication","profile-reminders"].forEach(o=>{const n=document.getElementById(o);n&&e[o]&&(n.value=e[o])}),console.log("Profile data loaded")}setupProfileActions(){const e=document.getElementById("save-profile");e&&e.addEventListener("click",()=>{this.saveProfileData()});const t=document.querySelectorAll("#panel-profile input, #panel-profile textarea, #panel-profile select");let o;t.forEach(n=>{n.addEventListener("input",()=>{clearTimeout(o),o=setTimeout(()=>{this.saveProfileData(!0)},2e3)})})}saveProfileData(e=!1){const t={};["profile-name","profile-pronouns","profile-age-range","profile-challenges","profile-triggers","profile-coping","profile-goals","profile-communication","profile-reminders"].forEach(n=>{const s=document.getElementById(n);s&&(t[n]=s.value.trim())}),localStorage.setItem("smile-profile-data",JSON.stringify(t)),e||this.showCustomNotification("Profile saved successfully!","success"),this.updateProfileDependentUI(),console.log("Profile data saved:",t)}updateProfileDependentUI(){const t=JSON.parse(localStorage.getItem("smile-profile-data")||"{}")["profile-name"],o=document.getElementById("user-greeting");o&&t&&(o.textContent=`Hello, ${t}!`)}initHistorySearch(){const e=document.getElementById("history-search"),t=document.getElementById("clear-search"),o=document.getElementById("history-container");if(!e||!t||!o)return;const n=s=>{const r=o.querySelectorAll(".conversation-item");let i=0;r.forEach(l=>{const c=l,m=c.querySelector(".journal-entry-title")?.textContent?.toLowerCase()||"",u=c.querySelector(".journal-entry-content")?.textContent?.toLowerCase()||"",d=c.getAttribute("data-keywords")?.toLowerCase()||"",h=Array.from(c.querySelectorAll(".filter-chip")).map(f=>f.textContent?.toLowerCase()||"").join(" "),y=`${m} ${u} ${d} ${h}`;s===""||y.includes(s.toLowerCase())?(c.style.display="block",i++,s?this.highlightSearchTerms(c,s):this.removeHighlights(c)):c.style.display="none"});const a=document.querySelector("#panel-history .section-count");a&&(a.textContent=i.toString()),t.classList.toggle("hidden",s==="")};e.addEventListener("input",s=>{const r=s.target.value.trim();n(r)}),t.addEventListener("click",()=>{e.value="",n(""),e.focus()}),document.addEventListener("panelSwitch",()=>{e.value&&(e.value="",n(""))})}highlightSearchTerms(e,t){this.removeHighlights(e);const o=t.toLowerCase().split(/\s+/).filter(s=>s.length>0);if(o.length===0)return;this.getTextNodes(e).forEach(s=>{const r=s.textContent||"";let i=r;if(o.forEach(a=>{const l=new RegExp(`(${this.escapeRegExp(a)})`,"gi");i=i.replace(l,'<mark class="search-highlight">$1</mark>')}),i!==r){const a=document.createElement("span");a.innerHTML=i,s.parentNode?.replaceChild(a,s)}})}removeHighlights(e){e.querySelectorAll(".search-highlight").forEach(o=>{const n=o.parentNode;n&&(n.replaceChild(document.createTextNode(o.textContent||""),o),n.normalize())})}getTextNodes(e){const t=[],o=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,{acceptNode:s=>{const r=s.parentElement;return r&&(r.tagName==="INPUT"||r.tagName==="BUTTON"||r.tagName==="SCRIPT")?NodeFilter.FILTER_REJECT:s.textContent?.trim()?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_REJECT}});let n;for(;n=o.nextNode();)t.push(n);return t}escapeRegExp(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>new g):new g;
